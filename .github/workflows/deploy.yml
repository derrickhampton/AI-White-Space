name: Deploy to Domain.com (SFTP â†’ FTPS with debug)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      HOST: ${{ secrets.FTP_SERVER }}     # e.g. 116bbd3.dcomhost.com
      USER: ${{ secrets.FTP_USERNAME }}
      PASS: ${{ secrets.FTP_PASSWORD }}
      REMOTE: ${{ secrets.REMOTE_DIR }}   # e.g. public_html/  (can be subfolder)
      LOCAL: ./                           # change to ./dist if you build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # If you build, uncomment and set LOCAL to ./dist
      # - name: Setup Node
      #   uses: actions/setup-node@v4
      #   with:
      #     node-version: '20'
      # - name: Install & Build
      #   run: |
      #     npm ci
      #     npm run build
      #     echo "LOCAL=./dist" >> $GITHUB_ENV

      - name: Validate inputs
        shell: bash
        run: |
          set -euo pipefail
          [ -n "${HOST:-}" ]  || { echo "âŒ Missing secret: FTP_SERVER"; exit 1; }
          [ -n "${USER:-}" ]  || { echo "âŒ Missing secret: FTP_USERNAME"; exit 1; }
          [ -n "${PASS:-}" ]  || { echo "âŒ Missing secret: FTP_PASSWORD"; exit 1; }
          [ -n "${REMOTE:-}" ]|| { echo "âŒ Missing secret: REMOTE_DIR (e.g. public_html/)"; exit 1; }
          [ -d "${LOCAL}" ]   || { echo "âŒ Local dir ${LOCAL} not found"; ls -la; exit 1; }
          case "$REMOTE" in */) ;; *) REMOTE="${REMOTE}/";; esac
          echo "â„¹ï¸ Host: $HOST"
          echo "â„¹ï¸ Remote: $REMOTE"
          echo "â„¹ï¸ Local:  $LOCAL"
          echo "REMOTE=$REMOTE" >> "$GITHUB_ENV"

      - name: Install lftp
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp

      - name: Probe SFTP (port 22) with debug
        id: probe_sftp
        shell: bash
        run: |
          set +e
          echo "ðŸ”Ž Testing SFTP to $HOST:22 ..."
          lftp -d -u "$USER","$PASS" "sftp://$HOST:22" -e "set sftp:auto-confirm yes; set net:timeout 15; debug 9; pwd; ls -la \"$REMOTE\"; bye"
          echo "exit_code=$?" >> "$GITHUB_OUTPUT"

      - name: Deploy via SFTP (if probe OK)
        if: steps.probe_sftp.outputs.exit_code == '0'
        shell: bash
        run: |
          set -e
          echo "ðŸš€ SFTP deploy â†’ $HOST:$REMOTE"
          lftp -d -u "$USER","$PASS" "sftp://$HOST:22" -e "\
            set sftp:auto-confirm yes; \
            set net:max-retries 5; \
            set net:timeout 30; \
            set net:reconnect-interval-base 5; \
            set net:reconnect-interval-max 20; \
            mkdir -p -f \"$REMOTE\"; \
            mirror -Rev --parallel=2 --only-newer \
              --exclude-glob .git* \
              --exclude-glob .github \
              --exclude-glob node_modules \
              --exclude-glob '*.map' \
              --exclude-glob README.md \
              \"$LOCAL\" \"$REMOTE\"; \
            bye"

      - name: Probe FTPS explicit (port 21) with debug
        if: steps.probe_sftp.outputs.exit_code != '0'
        id: probe_ftps
        shell: bash
        run: |
          set +e
          echo "ðŸ”Ž SFTP failed. Testing FTPS (explicit TLS) to $HOST:21 ..."
          lftp -d -u "$USER","$PASS" "$HOST" -p 21 -e "\
            set ftp:passive-mode yes; \
            set ftp:ssl-force yes; \
            set ftp:ssl-protect-data yes; \
            set ssl:verify-certificate no; \
            set net:timeout 15; \
            debug 9; pwd; ls -la \"$REMOTE\"; bye"
          echo "exit_code=$?" >> "$GITHUB_OUTPUT"

      - name: Deploy via FTPS explicit (if probe OK)
        if: steps.probe_sftp.outputs.exit_code != '0' && steps.probe_ftps.outputs.exit_code == '0'
        shell: bash
        run: |
          set -e
          echo "ðŸš€ FTPS deploy â†’ $HOST:$REMOTE"
          lftp -d -u "$USER","$PASS" "$HOST" -p 21 -e "\
            set ftp:passive-mode yes; \
            set ftp:ssl-force yes; \
            set ftp:ssl-protect-data yes; \
            set ssl:verify-certificate no; \
            set net:max-retries 5; \
            set net:timeout 30; \
            set net:reconnect-interval-base 5; \
            set net:reconnect-interval-max 20; \
            mkdir -p -f \"$REMOTE\"; \
            mirror -Rev --parallel=2 --only-newer \
              --exclude-glob .git* \
              --exclude-glob .github \
              --exclude-glob node_modules \
              --exclude-glob '*.map' \
              --exclude-glob README.md \
              \"$LOCAL\" \"$REMOTE\"; \
            bye"

      - name: Fail with helpful hint
        if: steps.probe_sftp.outputs.exit_code != '0' && steps.probe_ftps.outputs.exit_code != '0'
        run: |
          echo "::error::Could not connect via SFTP:22 or FTPS:21. Check that your Domain.com plan allows SFTP (SSH) or at least FTPS, verify credentials, and confirm the remote path (${REMOTE})."
          exit 1
