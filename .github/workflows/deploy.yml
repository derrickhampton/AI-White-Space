name: Deploy to Domain.com (diagnose + deploy)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      HOST: ${{ secrets.FTP_SERVER }}     # e.g. 116bbd3.dcomhost.com
      USER: ${{ secrets.FTP_USERNAME }}
      PASS: ${{ secrets.FTP_PASSWORD }}
      REMOTE: ${{ secrets.REMOTE_DIR }}   # e.g. public_html/ or public_html/ai-white-space/
      LOCAL: ./                           # change to ./dist if you build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate inputs
        shell: bash
        run: |
          set -euo pipefail
          [ -n "${HOST:-}" ]  || { echo "‚ùå Missing secret: FTP_SERVER"; exit 1; }
          [ -n "${USER:-}" ]  || { echo "‚ùå Missing secret: FTP_USERNAME"; exit 1; }
          [ -n "${PASS:-}" ]  || { echo "‚ùå Missing secret: FTP_PASSWORD"; exit 1; }
          [ -n "${REMOTE:-}" ]|| { echo "‚ùå Missing secret: REMOTE_DIR (e.g. public_html/)"; exit 1; }
          [ -d "${LOCAL}" ]   || { echo "‚ùå Local dir ${LOCAL} not found"; ls -la; exit 1; }
          case "$REMOTE" in */) ;; *) REMOTE="${REMOTE}/";; esac
          echo "‚ÑπÔ∏è Host:   $HOST"
          echo "‚ÑπÔ∏è Remote: $REMOTE"
          echo "‚ÑπÔ∏è Local:  $LOCAL"
          echo "REMOTE=$REMOTE" >> "$GITHUB_ENV"

      - name: Install lftp
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp

      - name: Probe SFTP (22) - list remote
        id: sftp_list
        shell: bash
        run: |
          set +e
          echo "üîé SFTP ls $HOST:22 ‚Üí $REMOTE"
          lftp -u "$USER","$PASS" "sftp://$HOST:22" -e "set sftp:auto-confirm yes; set net:timeout 20; ls -la \"$REMOTE\"; bye"
          echo "code=$?" >> "$GITHUB_OUTPUT"

      - name: Probe FTPS (21) - list remote
        if: steps.sftp_list.outputs.code != '0'
        id: ftps_list
        shell: bash
        run: |
          set +e
          echo "üîé FTPS ls $HOST:21 ‚Üí $REMOTE"
          lftp -u "$USER","$PASS" "$HOST" -p 21 -e "set ftp:passive-mode yes; set ftp:ssl-force yes; set ftp:ssl-protect-data yes; set ssl:verify-certificate no; set net:timeout 20; ls -la \"$REMOTE\"; bye"
          echo "code=$?" >> "$GITHUB_OUTPUT"

      - name: Fail fast if neither protocol works
        if: steps.sftp_list.outputs.code != '0' && steps.ftps_list.outputs.code != '0'
        run: |
          echo "::error::Cannot list $REMOTE via SFTP:22 or FTPS:21. Likely causes: wrong protocol on your plan, wrong REMOTE_DIR, or host blocking GitHub runners."
          exit 1

      - name: Create marker file
        run: |
          echo "deployed $(date -u +%FT%TZ) from AI-White-Space" > .deploy-ok

      - name: Upload marker via SFTP
        if: steps.sftp_list.outputs.code == '0'
        shell: bash
        run: |
          set -e
          echo "üìù SFTP put .deploy-ok ‚Üí $REMOTE"
          lftp -u "$USER","$PASS" "sftp://$HOST:22" -e "set sftp:auto-confirm yes; set net:timeout 30; put -O \"$REMOTE\" .deploy-ok; bye"

      - name: Upload marker via FTPS
        if: steps.sftp_list.outputs.code != '0' && steps.ftps_list.outputs.code == '0'
        shell: bash
        run: |
          set -e
          echo "üìù FTPS put .deploy-ok ‚Üí $REMOTE"
          lftp -u "$USER","$PASS" "$HOST" -p 21 -e "set ftp:passive-mode yes; set ftp:ssl-force yes; set ftp:ssl-protect-data yes; set ssl:verify-certificate no; set net:timeout 30; put -O \"$REMOTE\" .deploy-ok; bye"

      - name: Mirror via SFTP
        if: steps.sftp_list.outputs.code == '0'
        shell: bash
        run: |
          set -e
          echo "üöÄ SFTP mirror $LOCAL ‚Üí $REMOTE"
          lftp -u "$USER","$PASS" "sftp://$HOST:22" -e "\
            set sftp:auto-confirm yes; set net:max-retries 5; set net:timeout 30; \
            mkdir -p -f \"$REMOTE\"; \
            mirror -Rev --parallel=2 --only-newer \
              --exclude-glob .git* --exclude-glob .github --exclude-glob node_modules \
              --exclude-glob '*.map' --exclude-glob README.md \
              \"$LOCAL\" \"$REMOTE\"; \
            bye"

      - name: Mirror via FTPS
        if: steps.sftp_list.outputs.code != '0' && steps.ftps_list.outputs.code == '0'
        shell: bash
        run: |
          set -e
          echo "üöÄ FTPS mirror $LOCAL ‚Üí $REMOTE"
          lftp -u "$USER","$PASS" "$HOST" -p 21 -e "\
            set ftp:passive-mode yes; set ftp:ssl-force yes; set ftp:ssl-protect-data yes; set ssl:verify-certificate no; \
            set net:max-retries 5; set net:timeout 30; \
            mkdir -p -f \"$REMOTE\"; \
            mirror -Rev --parallel=2 --only-newer \
              --exclude-glob .git* --exclude-glob .github --exclude-glob node_modules \
              --exclude-glob '*.map' --exclude-glob README.md \
              \"$LOCAL\" \"$REMOTE\"; \
            bye"
