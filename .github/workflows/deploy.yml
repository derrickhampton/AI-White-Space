name: Deploy to Domain.com via SFTP

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      HOST: ${{ secrets.FTP_SERVER }}      # e.g. 116bbd3.dcomhost.com
      USER: ${{ secrets.FTP_USERNAME }}
      PASS: ${{ secrets.FTP_PASSWORD }}
      REMOTE: ${{ secrets.REMOTE_DIR }}    # e.g. public_html/
      LOCAL: ./                            # change to ./dist if you build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fail fast if inputs missing
        shell: bash
        run: |
          set -e
          [ -n "$HOST" ]  || { echo "Missing secret: FTP_SERVER"; exit 1; }
          [ -n "$USER" ]  || { echo "Missing secret: FTP_USERNAME"; exit 1; }
          [ -n "$PASS" ]  || { echo "Missing secret: FTP_PASSWORD"; exit 1; }
          [ -n "$REMOTE" ]|| { echo "Missing secret: REMOTE_DIR (e.g. public_html/)"; exit 1; }
          [ -d "$LOCAL" ] || { echo "Local dir $LOCAL not found"; exit 1; }
          case "$REMOTE" in */) ;; *) echo "REMOTE normalized to $REMOTE/"; echo "REMOTE=$REMOTE/" >> $GITHUB_ENV ;; esac

      - name: Install lftp
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp

      - name: Connectivity check (SFTP 22)
        shell: bash
        run: |
          set -e
          echo "Checking SFTP connectivity to $HOST:22 ..."
          lftp -u "$USER","$PASS" "sftp://$HOST:22" -e "set sftp:auto-confirm yes; set net:timeout 15; ls -l \"${REMOTE:-$REMOTE}\"; bye"

      - name: Deploy via SFTP
        shell: bash
        run: |
          set -e
          echo "Deploying $LOCAL â†’ $HOST:${REMOTE:-$REMOTE} via SFTP"
          lftp -u "$USER","$PASS" "sftp://$HOST:22" -e "\
            set sftp:auto-confirm yes; \
            set net:max-retries 5; \
            set net:timeout 25; \
            set net:reconnect-interval-base 5; \
            set net:reconnect-interval-max 20; \
            mkdir -p -f \"${REMOTE:-$REMOTE}\"; \
            mirror -Rev --parallel=2 --only-newer \
              --exclude-glob .git* \
              --exclude-glob .github \
              --exclude-glob node_modules \
              --exclude-glob '*.map' \
              --exclude-glob README.md \
              \"$LOCAL\" \"${REMOTE:-$REMOTE}\"; \
            bye"
