<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hidden-Character Highlighter</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 2rem;
    }
    textarea {
      width: 100%;
      height: 150px;
      font-family: monospace;
      font-size: 1rem;
      margin-bottom: 1rem;
    }
    #output {

    white-space: pre-wrap;       /* respect line breaks and wrap */
    word-wrap: break-word;       /* break long words */
    border: 1px solid #ccc;
    padding: .5rem;
    font-family: monospace;
    font-size: 1rem;
    background: #f9f9f9;
  }
    .highlight {
      background: #ffeb3b;
      color: #000;
      font-weight: bold;
      border-radius: 2px;
      padding: 0 2px;
    }

    /* Simple modal */
    #modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,.6);
      align-items: center;
      justify-content: center;
    }
    #modal .content {
      background: #fff;
      padding: 1.5rem;
      border-radius: 4px;
      max-width: 90%;
      box-shadow: 0 2px 10px rgba(0,0,0,.3);
    }
    #modal .close {
      float: right;
      cursor: pointer;
      font-size: 1.2rem;
    }
  </style>
</head>
<body>
  <h1>Hidden-Character Highlighter</h1>
  
  <p>Paste or type text with hidden characters below:</p>
  <div id="message"></div>
  <textarea id="input" placeholder="Enter text hereâ€¦"></textarea>
  <p>Output with hidden characters highlighted:</p>
  <div id="output"></div>

  <!-- Modal -->
  <div id="modal">
    <div class="content">
      <span class="close">&times;</span>
      <h2>Hidden Whitespace Detected</h2>
      <p>The following hidden characters were found:</p>
      <ul id="foundList"></ul>
    </div>
  </div>

  <script>

    const MAX_TRIES = 5;
    const STORAGE_KEY = 'ws_tool_tries';

    // Load current count or initialize to 0
    let tries = parseInt(localStorage.getItem(STORAGE_KEY) || '0', 10);

    function updateMessage() {
      if (tries >= MAX_TRIES) {
        messageEl.textContent =
          `You have used all ${MAX_TRIES} tries. Please come back later.`;
        inputEl.disabled = true;
      } else {
        messageEl.textContent =
          `Tries: ${tries} of ${MAX_TRIES}`;
        inputEl.disabled = false;
      }
    }

    const mapping = {
      '\u00A0': 'NBSP',
      '\u200B': 'ZWSP',
      '\u200C': 'ZWNJ',
      '\u200D': 'ZWJ',
      '\u2060': 'WORD_JOINER',
      '\u200A': 'HAIR_SPACE',
      '\u2009': 'THIN_SPACE',
      '\u2007': 'FIGURE_SPACE',
      '\u2002': 'EN_SPACE',
      '\u2003': 'EM_SPACE',
      '\u202F': 'NNB_SPACE'
    };

    const inputEl = document.getElementById('input');
    const outputEl = document.getElementById('output');
    const modal = document.getElementById('modal');
    const foundList = document.getElementById('foundList');
    const messageEl = document.getElementById('message');
    const closeBtn = modal.querySelector('.close');

    function highlightHidden(text) {
      let result = '';
      const found = new Set();

      for (let ch of text) {
        if (mapping[ch]) {
          found.add(mapping[ch]);
          result += `<span class="highlight">[${mapping[ch]}]</span>`;
        } else {
          result += ch
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
        }
      }

      // If any hidden chars found, show modal
      if (found.size) {
        showModal(Array.from(found));
      } else {
        closeModal();
      }

      return result;
    }

    function showModal(items) {
      // clear old list
      foundList.innerHTML = '';
      items.forEach(name => {
        const li = document.createElement('li');
        li.textContent = name;
        foundList.appendChild(li);
      });
      modal.style.display = 'flex';
    }

    function closeModal() {
      modal.style.display = 'none';
    }

    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', e => {
      if (e.target === modal) closeModal();
    });

    inputEl.addEventListener('input', () => {
      if (tries >= MAX_TRIES) {
        // block further processing
        return;
      }
      // consume a try
      tries++;
      localStorage.setItem(STORAGE_KEY, tries);
      updateMessage();
      outputEl.innerHTML = highlightHidden(inputEl.value);
    });

    // Initialize
    outputEl.innerHTML = highlightHidden(inputEl.value);
    updateMessage();
  </script>
</body>
</html>
